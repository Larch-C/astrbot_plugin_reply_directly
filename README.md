# AstrBot 沉浸式交互插件 (ReplyDirectly)

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

一个为 [AstrBot](https://github.com/AstrBotDevs/AstrBot) 设计的交互增强插件，旨在让机器人更智能、更主动地参与对话。

本插件实现了两个核心功能，让您的 Bot 拥有更接近人类的聊天行为：

1.  **沉浸式对话**：当大语言模型（LLM）认为与用户的对话十分投机时，它可以决定在下一次主动回复用户，即使用户没有 `@` 机器人。此效果仅生效一次，避免了不必要的打扰。
2.  **主动插话**：在机器人发言后，它会“聆听”一小段时间。如果这段时间内群内的对话内容与它相关或它认为可以提供帮助，它会主动加入讨论，就像一个真正的群聊成员。

所有功能均可在 AstrBot 的 WebUI 中进行配置，方便您随时开启、关闭或调整。

## 功能详解

### 1. 沉浸式对话 (Sticky Reply)

**解决痛点**：在连续对话中，每次都需要 `@` 机器人会打断聊天的流畅感。

**工作流程**：
1.  用户与机器人进行对话。
2.  当对话内容让 LLM 觉得“聊上头了”（例如，用户说“我们聊得很开心”或表达了强烈的继续对话意愿），LLM 可以通过内置的函数工具 `enable_direct_reply_once` 将当前会话标记。
3.  用户下一次在该会话（私聊或群聊）中发言时，即使没有 `@` 机器人，机器人也会像等待回复一样，主动对该消息进行应答。
4.  该主动回复效果仅触发一次，之后恢复为需要 `@` 的常规模式，确保了交互的智能性和非侵入性。

### 2. 主动插话 (Proactive Reply)

**解决痛点**：机器人通常只在被动触发时才会响应，缺乏参与感。

**工作流程**：
1.  机器人在会话中发送了一条消息。
2.  插件开始一个可配置的计时器（例如 5 秒）。
3.  在这 5 秒内，插件会收集所有新的聊天记录。
4.  计时结束后，插件会将这期间收集到的新聊天记录发送给 LLM，并询问一个特定问题：“根据这些新内容，我此时插话是否合适？”
5.  LLM 会以 JSON 格式返回决策，判断是否应该回复以及回复什么内容。
6.  如果 LLM 决定插话，机器人会将回复内容主动发送到群聊/私聊中。
7.  如果在计时期间有任何新消息（包括用户或机器人自己发言），计时器会自动重置或取消，以确保只在对话的“间歇期”进行判断。

## 安装方法

1.  确保您的 AstrBot 版本支持插件系统。
2.  进入 AstrBot 的 `data/plugins` 目录。
3.  克隆本仓库：
    ```bash
    git clone https://github.com/qa296/astrbot_plugin_reply_directly--- # 替换为您的仓库地址
    ```
4.  重启 AstrBot 或在 WebUI 的插件管理页面点击“加载新插件”。
5.  在“已安装插件”列表中找到 `ReplyDirectly`，点击“管理”进入配置页面。

## 配置说明

您可以在 AstrBot WebUI 的插件管理页面对本插件进行详细配置。

| 配置项 | 类型 | 默认值 | 描述 |
| :--- | :--- | :--- | :--- |
| **插件总开关** | 开关 | `开启` | 控制整个插件的启用和禁用。 |
| **沉浸式对话设置** | - | - | - |
| &nbsp;&nbsp; 开启沉浸式对话 | 开关 | `开启` | 控制“沉浸式对话”功能的开关。 |
| **主动插话设置** | - | - | - |
| &nbsp;&nbsp; 开启主动插话 | 开关 | `开启` | 控制“主动插话”功能的开关。 |
| &nbsp;&nbsp; 延迟时间（秒） | 整数 | `5` | 机器人发言后，等待多少秒再检查聊天记录以判断是否插话。 |
| &nbsp;&nbsp; 分析历史消息数量 | 整数 | `10` | 在判断是否插话时，最多分析最近的多少条消息。 |

## 使用示例

### 沉浸式对话

> **你**：你真是一个有趣的 AI，我们聊得很投机！
>
> **你 (下一句话，没有@机器人)**：对了，我刚才忘了问，明天天气怎么样？
>
> **机器人 (主动回复)**：很高兴我们聊得来！关于天气，我查了一下，明天将会是晴天...

### 主动插话

> **机器人**：好的，我已经帮你设置了明天早上 8 点的提醒。
>
> *(...等待 5 秒...)*
>
> *(在这 5 秒内)*
> > **用户A**：说起来，明天早上是不是要开会来着？
> > **用户B**：对，好像是 9 点的。
>
> *(5 秒计时结束，LLM 分析了 A 和 B 的对话)*
>
> **机器人 (主动插话)**：@用户A @用户B 我注意到你们在讨论明天的会议，需要我为你们也设置一个会议提醒吗？
